<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="unifir">
<title>unifir 102 - A developer's guide • unifir</title>
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://docs.ropensci.org/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="unifir 102 - A developer's guide">
<meta property="og:description" content="unifir">
<meta property="og:image" content="https://docs.ropensci.org/unifir/logo.png">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Matomo --><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
<!-- End Matomo Code -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">unifir</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2.4.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/unifir-asset-guide.html">unifir 103 - Using Assets</a>
    <a class="dropdown-item" href="../articles/unifir-dev-guide.html">unifir 102 - A developer's guide</a>
    <a class="dropdown-item" href="../articles/unifir-user-guide.html">unifir 101 - A user's guide</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ropensci/unifir/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>unifir 102 - A developer's guide</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/unifir/blob/HEAD/vignettes/unifir-dev-guide.Rmd" class="external-link"><code>vignettes/unifir-dev-guide.Rmd</code></a></small>
      <div class="d-none name"><code>unifir-dev-guide.Rmd</code></div>
    </div>

    
    
<p>This document provides an overview of the inner workings of unifir, focusing on how scripts, props, and actions work together to produce a Unity scene. The tone and focus here are going to be extremely technical and fiddly; for a friendlier introduction to <a href="unifir-user-guide.html">unifir 101 - A user’s guide</a>.</p>
<p>At a high level, unifir operates around the idea of a <em>script</em> object, a container that stores all the parameters and instructions you want to run through Unity in a single place. Those parameters and instructions are specified in the form of <em>props</em>, which let users add certain parameterized pre-written commands to their script to execute in sequence. The actual execution is then handled by the <code><a href="../reference/action.html">action()</a></code> function, which both prepares the script for execution and then executes it. This basic pattern is modeled after the fantastic <a href="https://recipes.tidymodels.org/" class="external-link">recipes</a> package.</p>
<p>With that framework established, let’s walk through what exactly scripts and props are and how they interact with <code><a href="../reference/action.html">action()</a></code>. But first, we should talk about <code><a href="../reference/waiver.html">waiver()</a></code>.</p>
<div class="section level2">
<h2 id="waivers">Waivers<a class="anchor" aria-label="anchor" href="#waivers"></a>
</h2>
<p>As we’ll discuss in a moment, unifir does a lot of input checking to make sure that scripts are going to execute successfully in an attempt to give users more useful feedback than Unity’s command line interface often offers. That involves making sure that scripts and props have the correct values provided to all of their parameters, and also validating that the user is going to have a working version of Unity to run these commands in at all.</p>
<p>Of course, a short list of places that <em>don’t</em> have a working version of Unity includes “CRAN check machines” and “GitHub actions”. And so as a result, even the simplest function calls will fail on CRAN – for instance, running the following would throw an error:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/unifir/">unifir</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/make_script.html">make_script</a></span><span class="op">(</span><span class="st">"example"</span><span class="op">)</span></span></code></pre></div>
<p>In order to work around this, I’ve borrowed an idea (and the entire function) from ggplot2: <code><a href="../reference/waiver.html">waiver()</a></code>. The <code><a href="../reference/waiver.html">waiver()</a></code> function is a way to indicate to unifir that yes, you <em>know</em> this value normally needs to be provided, and you <em>know</em> that it’s missing, and that’s <em>fine</em>. All <code><a href="../reference/waiver.html">waiver()</a></code> does is return an object of class <code>waiver</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/waiver.html">waiver</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; list()</span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "waiver"</span></span></code></pre></div>
<p>On its own, this object doesn’t do anything. However, in a few key places, unifir will understand <code><a href="../reference/waiver.html">waiver()</a></code> as meaning “don’t validate this argument”, which is essential for some odd props and CRAN checks to succeed. I’ll be using it throughout this vignette, starting with:</p>
</div>
<div class="section level2">
<h2 id="scripts">Scripts<a class="anchor" aria-label="anchor" href="#scripts"></a>
</h2>
<p>The “script” is the core object in unifir. To create a script, we use <code>make_script</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">script</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_script.html">make_script</a></span><span class="op">(</span></span>
<span>  project <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"unifir"</span><span class="op">)</span>,</span>
<span>  unity <span class="op">=</span> <span class="fu"><a href="../reference/waiver.html">waiver</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># Don't error if we can't find Unity</span></span>
<span><span class="op">)</span></span>
<span><span class="va">script</span></span>
<span><span class="co">#&gt; A `unifir_script` object with 0 props</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [1] name type</span></span>
<span><span class="co">#&gt; &lt;0 rows&gt; (or 0-length row.names)</span></span></code></pre></div>
<p>This creates an <a href="https://github.com/r-lib/R6" class="external-link">R6</a> object of the class <code>unifir_script</code>. If you haven’t worked with R6 before, I recommend checking out <a href="https://adv-r.hadley.nz/r6.html" class="external-link">the section of Advanced R on the subject</a>. At the end of the day, however, a script is effectively just a glorified list. We can check out its contents using <code><a href="https://rdrr.io/r/base/names.html" class="external-link">names()</a></code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">script</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] ".__enclos_env__"    "using"              "beats"             </span></span>
<span><span class="co">#&gt;  [4] "props"              "initialize_project" "unity"             </span></span>
<span><span class="co">#&gt;  [7] "scene_exists"       "scene_name"         "script_name"       </span></span>
<span><span class="co">#&gt; [10] "project"            "clone"              "initialize"</span></span></code></pre></div>
<p>Some of these contents – <code>.__encols_env__</code>, <code>clone</code>, <code>initialize</code> – will be familiar to anyone used to working with R6. Others, such as the file names for the scene and script unifir is operating on, are set in <code><a href="../reference/make_script.html">make_script()</a></code> (and documented in <code><a href="../reference/make_script.html">?make_script</a></code>) and default to <code>NULL</code> if not set:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">script</span><span class="op">$</span><span class="va">initialize_project</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">script</span><span class="op">$</span><span class="va">scene_name</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">script</span><span class="op">$</span><span class="va">script_name</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>Others, like <code>using</code>, <code>beats</code>, and <code>props</code>, are a little bit more involved. We’ll use these objects in order to track the props we add to our script; to talk about that, it’s time we talk about props.</p>
</div>
<div class="section level2">
<h2 id="props">Props<a class="anchor" aria-label="anchor" href="#props"></a>
</h2>
<p>At a low level, a unifir prop is just another R6 object, created using the function <code><a href="../reference/unifir_prop.html">unifir_prop()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prop_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.create</a></span><span class="op">(</span><span class="va">prop_file</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="va">prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/unifir_prop.html">unifir_prop</a></span><span class="op">(</span></span>
<span>  prop_file <span class="op">=</span> <span class="va">prop_file</span>,</span>
<span>  method_name <span class="op">=</span> <span class="st">"ExampleName"</span>,</span>
<span>  method_type <span class="op">=</span> <span class="st">"ExampleMethod"</span>,</span>
<span>  build <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">script</span>, <span class="va">prop</span>, <span class="va">debug</span><span class="op">)</span> <span class="op">{</span><span class="op">}</span>,</span>
<span>  using <span class="op">=</span> <span class="st">"ExampleDependencies"</span>,</span>
<span>  parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">prop</span></span>
<span><span class="co">#&gt; &lt;unifir_prop&gt;</span></span>
<span><span class="co">#&gt;   Public:</span></span>
<span><span class="co">#&gt;     build: function (script, prop, debug) </span></span>
<span><span class="co">#&gt;     clone: function (deep = FALSE) </span></span>
<span><span class="co">#&gt;     initialize: function (prop_file, method_name, method_type, parameters, build, </span></span>
<span><span class="co">#&gt;     method_name: ExampleName</span></span>
<span><span class="co">#&gt;     method_type: ExampleMethod</span></span>
<span><span class="co">#&gt;     parameters: list</span></span>
<span><span class="co">#&gt;     prop_file: /tmp/RtmpZ8MQVb/file96c6a17d075</span></span>
<span><span class="co">#&gt;     using: ExampleDependencies</span></span></code></pre></div>
<p>Just as before, we can see our prop’s contents using <code><a href="https://rdrr.io/r/base/names.html" class="external-link">names()</a></code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">prop</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] ".__enclos_env__" "using"           "build"           "parameters"     </span></span>
<span><span class="co">#&gt; [5] "method_type"     "method_name"     "prop_file"       "clone"          </span></span>
<span><span class="co">#&gt; [9] "initialize"</span></span></code></pre></div>
<p>These fields are all documented in <code><a href="../reference/unifir_prop.html">?unifir_prop</a></code>.</p>
<p>Prop objects are the actual method unifir uses to translate R inputs into C# methods. A typical prop will take some input parameters, provided either by the prop constructor function (more on that in a moment) or set at the script level, interpolate them into a pre-written C# method, and then add that method to a pile of C# code that will be run in sequence to produce a scene. Of course, the details of this process depend on what exactly the C# code is expected to <em>do</em>.</p>
<p>Most of those details are sorted out by prop constructor functions. Rather than forcing users to use <code><a href="../reference/unifir_prop.html">unifir_prop()</a></code> directly, unifir provides a number of wrappers around this function to add specific props to a script. For instance, if we look at the code that powers our <code><a href="../reference/new_scene.html">new_scene()</a></code> function:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_scene</span></span>
<span><span class="co">#&gt; function (script, setup = c("EmptyScene", "DefaultGameObjects"), </span></span>
<span><span class="co">#&gt;     mode = c("Additive", "Single"), method_name = NULL, exec = TRUE) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     setup &lt;- match.arg(setup)</span></span>
<span><span class="co">#&gt;     mode &lt;- match.arg(mode)</span></span>
<span><span class="co">#&gt;     prop &lt;- unifir_prop(prop_file = system.file("NewScene.cs", </span></span>
<span><span class="co">#&gt;         package = "unifir"), method_name = method_name, method_type = "NewScene", </span></span>
<span><span class="co">#&gt;         parameters = list(setup = setup, mode = mode), build = function(script, </span></span>
<span><span class="co">#&gt;             prop, debug) {</span></span>
<span><span class="co">#&gt;             glue::glue(readChar(prop$prop_file, file.info(prop$prop_file)$size), </span></span>
<span><span class="co">#&gt;                 .open = "%", .close = "%", method_name = prop$method_name, </span></span>
<span><span class="co">#&gt;                 setup = setup, mode = mode)</span></span>
<span><span class="co">#&gt;         }, using = c("UnityEngine.SceneManagement", "UnityEditor", </span></span>
<span><span class="co">#&gt;             "UnityEditor.SceneManagement"))</span></span>
<span><span class="co">#&gt;     add_prop(script, prop, exec)</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x5599c8629348&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:unifir&gt;</span></span></code></pre></div>
<p>This prop takes two parameters – <code>setup</code> and <code>mode</code> – and the top of the script makes sure they exist and are passed correctly. We then get to the internal <code><a href="../reference/unifir_prop.html">unifir_prop()</a></code> call. This call passes <code>system.file("NewScene.cs", package = "unifir")</code> to the <code>prop_file</code> argument; if we print that file out we can see that it’s a relatively simple C# method:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"NewScene.cs"</span>, package <span class="op">=</span> <span class="st">"unifir"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] ""                                                                                               </span></span>
<span><span class="co">#&gt; [2] "    static void %method_name%() {"                                                              </span></span>
<span><span class="co">#&gt; [3] "        var newScene = EditorSceneManager.NewScene(NewSceneSetup.%setup%, NewSceneMode.%mode%);"</span></span>
<span><span class="co">#&gt; [4] "    }"</span></span></code></pre></div>
<p>This method calls <code>EditorSceneManager.NewScene</code>, part of Unity’s scripting API, and uses it to create a new scene. Because this code relies on the “UnityEngine.SceneManagement”, “UnityEditor”, and “UnityEditor.SceneManagement” namespaces, we’ve included those namespaces in our prop’s <code>using</code> argument. Our R code is only going to edit three parts of this function, marked by <code>%</code> signs – the <code>method_name</code>, <code>setup</code>, and <code>mode</code> arguments will all be replaced by their equivalent values in R.</p>
<p>Moving further along the <code>unifir_prop</code> call, we can then see that <code>method_name</code> is set to <code>NULL</code> by default. <code>method_name</code> is a unique identifier for <em>this method of this prop</em>, so should not be hard-coded or provided as a default in your prop constructors. If you leave it as <code>NULL</code>, unifir will attempt to generate a name made of 4 random English words to fill in the space.</p>
<p>The next argument, <code>method_type</code>, is internally set to <code>NewScene</code> – users cannot control this value. <code>method_type</code> is meant to be a certain “key” associated with your specific type of prop, which other props might search for if they depend on or conflict with your code; as such, it generally shouldn’t be configurable by your users.</p>
<p>We then see that our function parameters are passed as a list to the <code>parameters</code> argument. These will be essential for our next argument, the <code>build()</code> function, which constructs our C# method. The <code>build()</code> function of every prop must take three (and only three) arguments: <code>script</code>, the unifir script a prop is stored in, <code>prop</code>, the prop being built, and <code>debug</code>, which is discussed below. <code>build()</code> methods with more arguments than this will cause errors. As a result, all other parameters you need to construct your C# method <em>must</em> be stored either in the prop or script object, and it is generally easiest to store them in <code>parameters</code> (which is not checked by the R6 class).</p>
<p>The actual build function here is relatively simple, using <code>glue</code> to replace the snippets between <code>%</code> symbols with their R equivalents. If we don’t change any of the default arguments to this function, that means our output C# method will look something like this:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">script</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_scene.html">new_scene</a></span><span class="op">(</span><span class="va">script</span><span class="op">)</span></span>
<span></span>
<span><span class="va">script</span><span class="op">$</span><span class="va">props</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">build</span><span class="op">(</span><span class="va">script</span>, <span class="va">script</span><span class="op">$</span><span class="va">props</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; static void HerthenTrackWhite() {</span></span>
<span><span class="co">#&gt;     var newScene = EditorSceneManager.NewScene(NewSceneSetup.EmptyScene, NewSceneMode.Additive);</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
<p>The last part of our prop constructor is the <code>add_prop</code> function, which registers the prop as part of our script. Its code is incredibly simple, and mostly deals with creating the <code>script$beats</code> table:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">add_prop</span></span>
<span><span class="co">#&gt; function (script, prop, exec = TRUE) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     stopifnot(is.logical(exec))</span></span>
<span><span class="co">#&gt;     stopifnot(methods::is(script, "unifir_script"))</span></span>
<span><span class="co">#&gt;     idx &lt;- nrow(script$beats) + 1</span></span>
<span><span class="co">#&gt;     script$props[[idx]] &lt;- prop</span></span>
<span><span class="co">#&gt;     script$beats[idx, ]$idx &lt;- idx</span></span>
<span><span class="co">#&gt;     script$beats[idx, ]$name &lt;- prop$method_name</span></span>
<span><span class="co">#&gt;     script$beats[idx, ]$type &lt;- prop$method_type</span></span>
<span><span class="co">#&gt;     script$beats[idx, ]$exec &lt;- exec</span></span>
<span><span class="co">#&gt;     script$using &lt;- c(script$using, prop$using)</span></span>
<span><span class="co">#&gt;     script</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x5599c843dde0&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:unifir&gt;</span></span></code></pre></div>
<p>That table is relatively simple, storing four variables: <code>idx</code>, the order that methods will be executed in, <code>name</code>, the <code>method_name</code> of each method, <code>type</code>, the <code>method_type</code> of each method, and <code>exec</code>, a boolean representing whether or not that method should be called in the final C# script:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">script</span><span class="op">$</span><span class="va">beats</span></span>
<span><span class="co">#&gt;    idx              name     type exec</span></span>
<span><span class="co">#&gt; NA   1 HerthenTrackWhite NewScene TRUE</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="action">Action<a class="anchor" aria-label="anchor" href="#action"></a>
</h2>
<p>With our props and scripts written, it’s showtime! We can use the <code>action</code> function to transform our R6 objects into an actual C# script, and then execute that script in Unity.</p>
<p>The <code><a href="../reference/action.html">action()</a></code> does quite a few things. Namely, it:</p>
<ul>
<li>Checks if the Unity project needs to be created, and creates it if so.<br>
</li>
<li>Fills in any missing directory or file names that were left as <code>NULL</code>.<br>
</li>
<li>Calls the <code>build()</code> method of each prop, in order of <code>script$beats$idx</code>, and stores the constructed C# methods back in the script.</li>
<li>Creates a “caller” function that will call every method where <code>script$beats$exec</code> is <code>TRUE</code> in sequential order.<br>
</li>
<li>If <code>write = TRUE</code>, writes a final C# script to file.</li>
<li>If <code>exec = TRUE</code>, executes the final C# script in Unity.</li>
</ul>
<p>Most of this process is internal and doesn’t matter for any prop constructors you write. So long as your prop is idempotent and can be constructed using its own <code>build</code> argument, <code><a href="../reference/action.html">action()</a></code> shouldn’t create any issues.</p>
<p>However, if it does cause trouble, <code><a href="../reference/action.html">action()</a></code> returns a constructed script object with props replaced by their equivalent C# code. That makes it easy to see how unifir interpreted your build argument; for instance, we can run our example script through <code><a href="../reference/action.html">action()</a></code> as so:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">script</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_script.html">make_script</a></span><span class="op">(</span></span>
<span>  project <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"unifir"</span><span class="op">)</span>,</span>
<span>  unity <span class="op">=</span> <span class="fu"><a href="../reference/waiver.html">waiver</a></span><span class="op">(</span><span class="op">)</span>, <span class="co"># Don't error if we can't find Unity</span></span>
<span>  initialize_project <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># Don't create the project -- so this runs on CRAN</span></span>
<span>  script_name <span class="op">=</span> <span class="st">"example_script"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">script</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_scene.html">new_scene</a></span><span class="op">(</span><span class="va">script</span><span class="op">)</span></span>
<span><span class="va">exec_script</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/action.html">action</a></span><span class="op">(</span></span>
<span>  <span class="va">script</span>,</span>
<span>  exec <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  write <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If we’re concerned about how unifir translated our prop code, we can find the rendered C# inside <code>props</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exec_script</span><span class="op">$</span><span class="va">props</span></span>
<span><span class="co">#&gt; [1] "static void ClimbAppleMorningStation() {\n    var newScene = EditorSceneManager.NewScene(NewSceneSetup.EmptyScene, NewSceneMode.Additive);\n}\n"</span></span></code></pre></div>
<p>To see the entire produced C# script, we need to read the actual script file itself:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"unifir"</span>, <span class="st">"Assets"</span>, <span class="st">"Editor"</span>, <span class="st">"example_script.cs"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "using UnityEngine.SceneManagement;"                                                              </span></span>
<span><span class="co">#&gt;  [2] "using UnityEditor;"                                                                              </span></span>
<span><span class="co">#&gt;  [3] "using UnityEditor.SceneManagement; "                                                             </span></span>
<span><span class="co">#&gt;  [4] ""                                                                                                </span></span>
<span><span class="co">#&gt;  [5] "public class example_script {"                                                                   </span></span>
<span><span class="co">#&gt;  [6] "static void ClimbAppleMorningStation() {"                                                        </span></span>
<span><span class="co">#&gt;  [7] "    var newScene = EditorSceneManager.NewScene(NewSceneSetup.EmptyScene, NewSceneMode.Additive);"</span></span>
<span><span class="co">#&gt;  [8] "}"                                                                                               </span></span>
<span><span class="co">#&gt;  [9] ""                                                                                                </span></span>
<span><span class="co">#&gt; [10] "    static void MainFunc() {"                                                                    </span></span>
<span><span class="co">#&gt; [11] "        ClimbAppleMorningStation();"                                                             </span></span>
<span><span class="co">#&gt; [12] "    }"                                                                                           </span></span>
<span><span class="co">#&gt; [13] "}"</span></span></code></pre></div>
<p>Notice how this code matches our prop, with two additions: first, all the namespaces we provided to <code>using</code> are now imported at the top of the script, and second a function <code>MainFunc</code> has been created to call our prop. When executing the C# script, unifir will execute this <code>MainFunc</code> method, which will in turn call each prop once in the order it’s listed in <code>script$beats</code>.</p>
</div>
<div class="section level2">
<h2 id="debug">Debug<a class="anchor" aria-label="anchor" href="#debug"></a>
</h2>
<p>One last thing to know about unifir is that it is also built with a “debug” mode, in which functions will make no changes to your file system. unifir code checks if it’s running in debug mode using the following code:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">debug</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"unifir_debugmode"</span><span class="op">)</span> <span class="op">!=</span> <span class="st">""</span> <span class="op">||</span></span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="st">"unifir_debugmode"</span><span class="op">)</span><span class="op">$</span><span class="va">unifir_debugmode</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">debug</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">debug</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>So if <code>unifir_debugmode</code> is set to any value either as an environment variable or as an option, unifir will avoid writing anything to file or making any changes to a user’s computer.</p>
<p>When <code><a href="../reference/action.html">action()</a></code> is called, it will provide the current state of <code>debug</code> to your prop’s <code>build</code> function. For the majority of props, this can be safely ignored; if all your prop does is add C# code to the final script, <code><a href="../reference/action.html">action()</a></code> will respect debug on your behalf. However, if your prop makes changes to the file system before the script is actually executed – for instance, by moving prefabs to the project directory or editing configuration files from R – make sure to wrap those sections of your prop in <code>if (!debug)</code>!</p>
</div>
<div class="section level2">
<h2 id="cloning">Cloning<a class="anchor" aria-label="anchor" href="#cloning"></a>
</h2>
<p>While I’ve avoided getting too deep into the underlying mechanics of R6 here, there’s one stumbling block that I want to flag for anyone interested in developing with unifir.</p>
<p>The vast majority of objects in R have what’s referred to as “copy-on-modify” semantics. Say for instance you have some object <code>x</code>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt; [1] 2</span></span></code></pre></div>
<p>If you assign <code>x</code> to a new object, <code>y</code>, we’d expect <code>y</code> and <code>x</code> to both have the same value:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span><span class="va">y</span> <span class="op">==</span> <span class="va">x</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>As an optimization on R’s part, not only are these objects both the same value, but they actually both point to the same piece of data on your machine. R only actually creates a new variable, pointing to its own unique data, when you actually modify the object. As a result, when you change the value of <code>x</code>, you <em>don’t</em> in turn change the value of <code>y</code>: R makes a copy when you modify the original object, so they now point to different data:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">y</span> <span class="op">==</span> <span class="va">x</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>The same is <strong>not true</strong> for R6 objects, like unifir scripts and props. If you assign a prop to a new object, both of the objects will point to the same data, and changing one object will change them both. This is true whether you change the new object:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">other_prop</span> <span class="op">&lt;-</span> <span class="va">prop</span></span>
<span><span class="va">other_prop</span><span class="op">$</span><span class="va">method_name</span> <span class="op">&lt;-</span> <span class="st">"NewName"</span></span>
<span><span class="va">prop</span><span class="op">$</span><span class="va">method_name</span></span>
<span><span class="co">#&gt; [1] "NewName"</span></span></code></pre></div>
<p>Or the original one:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prop</span><span class="op">$</span><span class="va">method_name</span> <span class="op">&lt;-</span> <span class="st">"AnotherName"</span></span>
<span><span class="va">other_prop</span><span class="op">$</span><span class="va">method_name</span></span>
<span><span class="co">#&gt; [1] "AnotherName"</span></span></code></pre></div>
<p>Instead, with R6 objects, we need to make an explicit copy. We can do this using the <code>clone()</code> function inside our prop object, like so:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">disconnected_prop</span> <span class="op">&lt;-</span> <span class="va">prop</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This creates an actual disconnected object, with the same values as the original it was cloned from. Now we can make changes to our prop (or script) without impacting any of the other copies:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">disconnected_prop</span><span class="op">$</span><span class="va">method_name</span> <span class="op">&lt;-</span> <span class="st">"OnlyIGetThisName"</span></span>
<span><span class="va">prop</span><span class="op">$</span><span class="va">method_name</span></span>
<span><span class="co">#&gt; [1] "AnotherName"</span></span></code></pre></div>
<p>Make sure that, if you’re trying to have multiple different versions of a prop or a script, you use <code>clone()</code> in your own code!</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>

  

  

  </body>
</html>
